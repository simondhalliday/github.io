---
title: "Marseille"
author: "Simon Halliday"
date: "2015-November -11"
output: html_document
---

```{r requirements, message = FALSE, warning = FALSE}
library(tidyr)
library(dplyr)
library(readr)
library(ggplot2)
```
Notice that you may have to install the `readr` package above. 


Import the data as follows. Notice that this is *different* to how we've historically imported data. This is because the data are in a .txt file and so we can't use `read.csv()`. Instead, we use `read_table()` from the `readr` package. 
```{r import Marseille}
Marseille <- read_table("/Users/shalliday/Google Drive/simondhalliday.github.io/bfh-textbook/indmarketdemand/MARS.txt", col_names = FALSE)
```

Look at the .txt file. Why do you think we had to specify the option `col_names = FALSE`? 

Head the data to look at it (it has an issue in one column I haven't been able to resolve yet, but it's fine for our needs - can you find the issue?):
```{r check Marseille}
head(Marseille)
```

We need to rename the variables to ones that are consistent with what we need to understand: 
```{r wrangling1}
Marseille <- 
  Marseille %>%
  rename(sellerb = X1, lot = X2, nbuyer = X3, date = X4, buyerc = X5, fish = X6, tempa = X7, tempb = X8) 
Mars <- 
  Marseille %>%
  mutate(weight = tempa/10, price = tempb/100)
head(Mars)
```

Don't run the code below yourselves (the sample size is huge and I don't know how powerful your laptops are), just look at the plot. What does it suggest?  
```{r AllFishPlot}
Mars %>% 
  ggplot(aes(x = weight, y = price)) + 
  geom_point() + 
  stat_smooth(method = "lm", formula = y ~ x, size = 1) +
  ylim(0, 100)
```

- What does the line correspond to? 
- What kind of pattern are you able to see? 

##A basic linear regression
Notice that you can run a linear regression with the whole sample of fish: 
```{r}
m1 <- lm(price ~ weight, data = Mars)
summary(m1)
```

- What is the sign on the for weight? 
- What is weight's significance? 
- What does the relationship mean in terms of economic theory? 

##Filtering the Fish
Consult the Marseille Data Description document to check what the different kinds of fish are. 

I have generated  the following graph for one of the kinds of fish (Merlan) by filtering and then graphing the data. 

Filtering for Merlan:
```{r MarlanData}
MarsFish44 <- 
  Mars %>%
  filter(fish == 44)
```

Graphing the Merlan data:
```{r MerlanPlot}
MarsFish44 %>% 
  ggplot(aes(x = weight, y = price)) + 
  geom_point() + 
  stat_smooth(method = "lm", formula = y ~ x, size = 1) +
  ylim(0, 100)
```

We can also run a linear regression just with the filtered Merlan data. 
```{r MerlanRegressions}
OLSMerlan <- lm(price ~ weight, data = MarsFish44)
summary(OLSMerlan)
```

Do the following: 

- Choose a fish in which you are interested and construct a data frame that contains only that kind of fish.
- Construct a plot for that fish's quantity-price observations
- Run a linear regression model of that fish's price-quantity relationship
- Summarize the regression output. 
- Submit your html of this later. 


#Multiple regression with dummy variables
We want to include dummy variables for the different kinds of fish in our regressions. So we need to check whether the fish variable is numeric or a factor. We could `head()` the data and see, but we can also get a "TRUE" or "FALSE" report using the `is.numeric()` or `is.factor()` functions. 
```{r}
is.numeric(Mars$fish)
is.factor(Mars$fish)
```

As you can see, we need to change `fish` into a *factor* variable. 

- How would you do this? 
- Do the variables have the labels you'd like them to have? (i.e. the names of the fish)
- Is there a way to remedy this? 

###Some ideas for factors
We need to take the information from the Marseille Data Details document and create two sets of columns using the following idea: `ObjectName <- c(content1, content2, ..., contentn)`. 

I would recommend you call the one object (with the numbers) `FishLevels` because it corresponds to the *levels* of your factor variable. 

I would recommend you call the second object `FishLabels` because it corresponds to the *labels* of the fish that you want. 

You will then use the function `factor()` inside the function `mutate()` (which you already know). 

You would then do something like the following (note this won't work because I don't have actual values:)
```{r, eval = FALSE}
MarsFactorFish <- 
  Mars %>% 
  mutate(fishvariablename = factor(fishvariablename, levels = FishLevels, labels = FishLabels))
```


You should get something like the following when you head your data: 
```{r, echo = FALSE}
FishLabels <- c("Merlan", "Carrelet", "Cabillaud", "Loup/Bar", " Raie Ange", "Raie (Entiere)", "Sole", "Turbot", "Cabillaud (Tranches)", "Sole (Filet)", "Annarrhyque (Filets)", "Loup (Filets)")
FishLevels <- c(44, 62, 77, 122, 204, 205, 214, 244, 285, 289, 314, 315)
Mars <- 
  Mars %>%
  mutate(fish = factor(fish, levels = FishLevels, labels = FishLabels))
head(Mars)
```

##Fish Factors in the Multiple Regression
Now, include the fish variables as factors in our regression 
```{r model with fish dummies}
m2 <- lm(price ~ weight + fish, data = Mars)
summary(m2)
```

##xtable for pretty tables
I'm going to recommend you consider installing the package `xtable` for thinking about the production of decent-looking tables. This isn't crucial for your project, but often useful. 
```{r}
library(xtable)
xt1 <- xtable(m2)
print(xt1, type = "html", file = "fishy1.html")
```

The table above generated html output in a file called "fishy.html". I have copy/pasted the html code below because it can be knitted straight into your html. If you want to knit to pdf, though, you should use the LaTex output that xtable generates instead (it would have `\begin{table}` at the beginning of the table and `\end{table}` at the end of the table). 

<!-- html table generated in R 3.2.0 by xtable 1.8-0 package -->
<!-- Tue Nov 17 13:21:03 2015 -->
<table border=1>
<tr> <th>  </th> <th> Estimate </th> <th> Std. Error </th> <th> t value </th> <th> Pr(&gt;|t|) </th>  </tr>
  <tr> <td align="right"> (Intercept) </td> <td align="right"> 32.2938 </td> <td align="right"> 0.0676 </td> <td align="right"> 477.93 </td> <td align="right"> 0.0000 </td> </tr>
  <tr> <td align="right"> weight </td> <td align="right"> -0.0657 </td> <td align="right"> 0.0010 </td> <td align="right"> -65.24 </td> <td align="right"> 0.0000 </td> </tr>
  <tr> <td align="right"> fishCarrelet </td> <td align="right"> -15.2820 </td> <td align="right"> 0.3974 </td> <td align="right"> -38.45 </td> <td align="right"> 0.0000 </td> </tr>
  <tr> <td align="right"> fishCabillaud </td> <td align="right"> -0.8326 </td> <td align="right"> 0.1060 </td> <td align="right"> -7.85 </td> <td align="right"> 0.0000 </td> </tr>
  <tr> <td align="right"> fishLoup/Bar </td> <td align="right"> 10.5332 </td> <td align="right"> 0.1204 </td> <td align="right"> 87.48 </td> <td align="right"> 0.0000 </td> </tr>
  <tr> <td align="right"> fish Raie Ange </td> <td align="right"> 4.9014 </td> <td align="right"> 0.1221 </td> <td align="right"> 40.16 </td> <td align="right"> 0.0000 </td> </tr>
  <tr> <td align="right"> fishRaie (Entiere) </td> <td align="right"> -1.6751 </td> <td align="right"> 3.1613 </td> <td align="right"> -0.53 </td> <td align="right"> 0.5962 </td> </tr>
  <tr> <td align="right"> fishSole </td> <td align="right"> 31.1003 </td> <td align="right"> 0.0859 </td> <td align="right"> 362.22 </td> <td align="right"> 0.0000 </td> </tr>
  <tr> <td align="right"> fishTurbot </td> <td align="right"> 36.6375 </td> <td align="right"> 0.2362 </td> <td align="right"> 155.08 </td> <td align="right"> 0.0000 </td> </tr>
  <tr> <td align="right"> fishCabillaud (Tranches) </td> <td align="right"> 8.8999 </td> <td align="right"> 0.6011 </td> <td align="right"> 14.81 </td> <td align="right"> 0.0000 </td> </tr>
  <tr> <td align="right"> fishSole (Filet) </td> <td align="right"> 39.1376 </td> <td align="right"> 0.6514 </td> <td align="right"> 60.08 </td> <td align="right"> 0.0000 </td> </tr>
  <tr> <td align="right"> fishAnnarrhyque (Filets) </td> <td align="right"> 12.3755 </td> <td align="right"> 0.2856 </td> <td align="right"> 43.33 </td> <td align="right"> 0.0000 </td> </tr>
  <tr> <td align="right"> fishLoup (Filets) </td> <td align="right"> 13.3184 </td> <td align="right"> 0.1987 </td> <td align="right"> 67.02 </td> <td align="right"> 0.0000 </td> </tr>
   </table>


End for today. 

