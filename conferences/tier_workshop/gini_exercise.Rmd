---
title: "Gini Exercise"
author: "Simon Halliday"
date: "2016-June -20"
output: html_document
---

##Intro 
This is my attempt to reproduce Richard Ball's Gini Index exercise with nothing other than the instructions. 

##Setup
I used the following packages
```{r setup}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggplot2)
library(tidyr)
library(readr)
```

We need to import the data. I had to open the data with Stata and run the .do file provided by IPUMS to get the data into a sensible shape. I then exported the data to csv. using the `outsheet` command. 

Below, I use `read_cvs` from the `readr` package to import the pretty large (~400mb) csv file
```{r import data}
CPS <- read_csv("/Users/shalliday/Google Drive/simondhalliday.github.io/conferences/tier_workshop/cps.csv")
```


##Generating variables
We only want household (HH) data, so I simply filter on the person codes so that I keep the first person in each HH. I also generate the real household income and real HH per capita incomes in the code below. 
```{r hh data filter}
CPShh <- 
  CPS %>%
  filter(pernum == 1) %>%
  mutate(realhhy = hhincome*cpi99, 
         realpcy = realhhy/numprec)
```

I next generate the two rank and covariance vectors by year. To do this, I use `group_by` from `dplyr`. 
```{r generate ranks and covariance}
CPShh2 <- 
  CPShh %>%
  group_by(year)%>%
  mutate(pcyrank = rank(realpcy, ties.method = c("random")), 
         hhyrank = rank(realhhy, ties.method = c("random")))
CPShh2 <- 
  CPShh2 %>%
  arrange(pcyrank) %>%
  mutate(covpcyrank = cov(realpcy, pcyrank))
CPShh3 <- 
  CPShh2 %>%
  arrange(hhyrank) %>% 
  mutate(covhhyrank = cov(realhhy, hhyrank))
```
I think some of the code above may be redundant, but such is life. 


To compute the Gini index, we need the mean household incomes, mean per capita incomes, total population of households.

```{r generate aggregate hh attributes}
CPShhy <- 
  CPShh %>%
  group_by(year) %>%
  summarise(meanhhy = mean(realhhy), 
            medhhy = median(realhhy),
            meanpcy = mean(realpcy), 
            medpcy = median(realpcy), 
            totalhh = n())
```

I now need to re-merge the data such that everyone in a given year has that year's aggregate attributes. 

Start with the per-capita data. 
```{r generate pc gini}
CPShh4 <- 
  CPShh2 %>% 
  left_join(CPShhy) %>%
  mutate(pcgini = (2*covpcyrank)/(totalhh*meanpcy))
head(CPShh4)
```

Now the HH data: 
```{r generate hh gini}
CPShh5 <- 
  CPShh3 %>% 
  left_join(CPShhy) %>%
  mutate(hhgini = (2*covhhyrank)/(totalhh*meanhhy))
head(CPShh5)
```

We now need to summarize this down to a year-specific variable. Because the number is a scalar and identical within year, the mean will be identical to each observation. 

For per-capita: 
```{r summary for pc gini}
CPSpcGini <- 
  CPShh4 %>%
  group_by(year) %>%
  summarise(pcgini = mean(pcgini))
```

For HH: 
```{r summary for hh gini}
CPShhGini <- 
  CPShh5 %>%
  group_by(year) %>%
  summarise(hhgini = mean(hhgini))
head(CPShhGini)
```

##Plots
To generate the plots, I need to `gather` the data (make it narrow) to have the relevant variable (income) in one column, with two different `types` of measure (median and mean) and I'll do the same for HH and per-capita: 

```{r gather hhy data}
CPShhyTemp <-  
  CPShhy %>%
  select(year, meanhhy, medhhy)
HHyplotdata <- 
  CPShhyTemp %>% 
  gather(type, hhincome, meanhhy:medhhy)
head(HHyplotdata)
```

Household income plot
```{r ggplot median and mean hhy}
HHyplotdata %>%
  ggplot(aes(x = year, y = hhincome, group = factor(type))) + 
  geom_line(aes(color = type)) +
  xlab("Year") +
  ylab("PC Income (in 1999 dollars)") +
  theme_bw()
```

Household Gini plot
```{r ggplot hhy gini}
CPShhGini %>%
  ggplot(aes(x = year, y = hhgini)) + 
  geom_line() +
  xlab("Year") +
  ylab("Gini Index (using hhy)") +
  theme_bw()
```

Per capita income generation
```{r gather pcy data}
CPShhpcyTemp <-  
  CPShhy %>%
  select(year, meanpcy, medpcy)
HHpcyplotdata <- 
  CPShhpcyTemp %>% 
  gather(type, pcy, meanpcy:medpcy)
head(HHpcyplotdata)
```

Per-capita income plot
```{r ggplot median and mean pcy}
HHpcyplotdata %>%
  ggplot(aes(x = year, y = pcy, group = factor(type))) + 
  geom_line(aes(color = type)) +
  xlab("Year") +
  ylab("HHIncome (in 1999 dollars)") +
  theme_bw()
```

Per-capita Gini plot
```{r ggplot pcy gini}
CPSpcGini %>%
  ggplot(aes(x = year, y = pcgini)) + 
  geom_line() +
  xlab("Year") +
  ylab("Gini index  (using pcy)") +
  theme_bw()
```




